---
title: "Co-Development of Obesity Risk, Depressive Symptoms, and Relative Pubertal Development"
author: "Olivia C. Robertson"
date: '06-30-2024'
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: false
    theme: cosmo
---

# [Purpose]{style="color:Purple"}

# This code conducts the data prep for a within race/ethnicity analysis for depression (CBCL - Depressin Subscale), obesity risk (Waist Circumference to Height Ratio [WC/HT]), and relative pubertal timing (Pubertal Development Scale) in ABCD.

## Identifiers

```{r buildlist 1}
##rm(list = ls()) 
library(psych)

#Load subject and family identifiers
Identifiers <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/abcd-general/abcd_y_lt.csv", header = TRUE, sep = ",", dec = ".")
#View(identifiers)

#print variable names and labels
#print(Identifiers[1,])

#Create key for Identifiers:
Identifiers.varlabels <- Identifiers[1,]

#Remove first row of Identifiers so we are left with only the data:
Identifiers.data <- Identifiers[-1,]

# Rename/recode variables
Identifiers.data$IID  <- Identifiers.data[,"src_subject_id"]
Identifiers.data$FID  <- Identifiers.data[,"rel_family_id"]
Identifiers.data$BID  <- Identifiers.data[,"rel_birth_id"]
#dim(Identifiers.data)

Identifiers.data <- Identifiers.data[order(Identifiers.data$IID,Identifiers.data$FID,Identifiers.data$BID),] 

#View(Identifiers.data)

Baseline.Identifiers<-Identifiers.data[Identifiers.data$eventname=="baseline_year_1_arm_1",]
Y1.Identifiers<-Identifiers.data[Identifiers.data$eventname=="1_year_follow_up_y_arm_1",]
Y2.Identifiers<-Identifiers.data[Identifiers.data$eventname=="2_year_follow_up_y_arm_1",]
Y3.Identifiers<-Identifiers.data[Identifiers.data$eventname=="3_year_follow_up_y_arm_1",]

#print(names(Identifiers.data))
#table(Identifiers.data$eventname)
#summary(Y1.data$interview_age)

# Load demographic data
demo <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/abcd-general/abcd_p_demo.csv", header = TRUE, sep = ",", dec= ".")
# View(identifiers)

# Print variable names and labels
print(demo[1,])

# Create key for Identifiers:
demo.varlabels <- demo[1,]

# Remove first row of Identifiers so we are left with only the data:
demo.data <- demo[-1,]

# Rename subject ID
demo.data$IID  <- demo.data[,"src_subject_id"]

# Baseline 
Baseline.demo<-demo.data[demo.data$eventname=="baseline_year_1_arm_1",]
colnames(Baseline.demo)[colnames(Baseline.demo) == "demo_sex_v2"] <- "sex"

# Create binary variables for each ethnicity
# 1 = White; 2 = Black; 3 = Hispanic; 4 = Asian; 5 = Other
freq_table <- table(Baseline.demo$race_ethnicity)
print(freq_table)

# Create binary variables for each ethnicity
Baseline.demo$White <- ifelse(Baseline.demo$race_ethnicity == 1, 1, 0)
Baseline.demo$Black <- ifelse(Baseline.demo$race_ethnicity == 2, 1, 0)
Baseline.demo$Hispanic <- ifelse(Baseline.demo$race_ethnicity == 3, 1, 0)
Baseline.demo$Asian <- ifelse(Baseline.demo$race_ethnicity == 4, 1, 0)
Baseline.demo$Other <- ifelse(Baseline.demo$race_ethnicity == 5, 1, 0)

# Calculate the frequency table for the White indicator variable
freq_White <- table(Baseline.demo$White)
print(freq_White)
freq_Black <- table(Baseline.demo$Black)
print(freq_Black)
freq_Hispanic <- table(Baseline.demo$Hispanic)
print(freq_Hispanic)
freq_Asian <- table(Baseline.demo$Asian)
print(freq_Asian)
freq_Other <- table(Baseline.demo$Other)
print(freq_Other)

# Subset dataset for White, Black, Hispanic
Baseline.demo <- subset(Baseline.demo, White == 1 | Black == 1 | Hispanic == 1)

# Create indicator var for subset analyses
Baseline.demo$race3 <- ifelse(Baseline.demo$White == 1, 1, 
                          ifelse(Baseline.demo$Black == 1, 2, 
                          ifelse(Baseline.demo$Hispanic == 1, 3, NA)))
freq_race3 <- table(Baseline.demo$race3)
#print(freq_race3)

# Subset so later data sets are smaller
Baseline.demo <- Baseline.demo[, c("IID", "sex", "race_ethnicity", "White", 
                                   "Black", "Hispanic", "Asian", "Other", "race3", 
                                   "demo_prnt_ed_v2_2yr_l", # Respondent 
                                   "demo_prtnr_ed_v2_2yr_l", # Partner
                                   "demo_comb_income_v2",
                                   "demo_prnt_age_v2")]

```

## Internalizing - Depression Subscale (int)

```{r buildlist 2}

#Load cbcl data
cbcl <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/mental-health/mh_p_cbcl.csv", header = TRUE, sep = ",", dec = ".")

#View(cbcl)
describe(cbcl$cbcl_scr_syn_withdep_r) #Internalizing CBCL Syndrome Scale (raw score)
summary(cbcl$cbcl_scr_syn_withdep_r)

#Create key for Identifiers:
cbcl.varlabels <- cbcl[1,]

#Remove first row of Identifiers so we are left with only the data:
cbcl.data <- cbcl[-1,]

#Rename subject ID
cbcl.data$IID  <- cbcl.data[,"src_subject_id"]

#Create 0, 1, 2,3 assessment data sets
Baseline.cbcl<-cbcl.data[cbcl.data$eventname=="baseline_year_1_arm_1",]
Y1.cbcl<-cbcl.data[cbcl.data$eventname=="1_year_follow_up_y_arm_1",]
Y2.cbcl<-cbcl.data[cbcl.data$eventname=="2_year_follow_up_y_arm_1",]
Y3.cbcl<-cbcl.data[cbcl.data$eventname=="3_year_follow_up_y_arm_1",]

###############################################################################
################################ Baseline (10.5)###############################
###############################################################################

# Merge Baseline.cbcl with Baseline.Identifiers based on IID to get age
Merged.Baseline_cbcl_identifiers <- merge(Baseline.cbcl, Baseline.Identifiers, by = "IID")

# Then, merge Merged.Baseline_cbcl_identifiers with baseline.demo based on IID to get sex variable
Merged.Baseline_ID_cbcl <- merge(Merged.Baseline_cbcl_identifiers, Baseline.demo, by = "IID")

############### Regress age out of depression score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Baseline_ID_cbcl)[colnames(Merged.Baseline_ID_cbcl) == "interview_age"] <- "age"
colnames(Merged.Baseline_ID_cbcl)[colnames(Merged.Baseline_ID_cbcl) == "cbcl_scr_syn_withdep_r"] <- "int" 

# Subset the data
int_raw <- Merged.Baseline_ID_cbcl[, c("IID", "age", "sex", "int" )]

# Make data set for boys and girls
boys_data <- int_raw[int_raw$sex == 1, ]
girls_data <- int_raw[int_raw$sex == 2, ]

#################### Regress internalizing scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on int and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
boys_data$intt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress int scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on int and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
girls_data$intt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine intt variables and create a new combined intt column
merged_data <- merged_data %>%
  mutate(intt = coalesce(intt.boys, intt.girls))

# Display the merged data with combined intt variable
# print(merged_data)

# Subset to only IDD and intt score
merged_data <- merged_data[, c("IID", "intt")]

# Merge with raw int data
merged_int <- merge(int_raw, merged_data, by = "IID", all = TRUE)
# print(merged_int)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Baseline <- c("IID","int","intt", "age")

# Convert the data frame to a data.table
setDT(merged_int)

# Subset the data table and create a new data table
subset_data <- merged_int[, ..variables_to_keep_Baseline]

# Rename the columns by appending "_Baseline"
colnames(subset_data) <- paste0(colnames(subset_data), "_Baseline")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Baseline"] <- "IID"

# rename data set for merge
int_Baseline <- subset_data

###############################################################################
################################ Year 1 (11.5) ################################
###############################################################################

# Merge Baseline.cbcl with Baseline.Identifiers based on IID to get age
Merged.Y1_cbcl_identifiers <- merge(Y1.cbcl, Y1.Identifiers, by = "IID")

# Then, merge Merged.Y1_cbcl_identifiers with baseline.demo based on IID to get sex variable
Merged.Y1_ID_cbcl <- merge(Merged.Y1_cbcl_identifiers, Baseline.demo, by = "IID")

############### Regress age out of BMI score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Y1_ID_cbcl)[colnames(Merged.Y1_ID_cbcl) == "interview_age"] <- "age"
colnames(Merged.Y1_ID_cbcl)[colnames(Merged.Y1_ID_cbcl) == "cbcl_scr_syn_withdep_r"] <- "int"

# Subset the data
int_raw <- Merged.Y1_ID_cbcl[, c("IID", "age", "sex", "int" )]

# Make data set for boys and girls
boys_data <- int_raw[int_raw$sex == 1, ]
girls_data <- int_raw[int_raw$sex == 2, ]

#################### Regress internalizing scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on int and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
boys_data$intt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress int scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on int and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
girls_data$intt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine intt variables and create a new combined intt column
merged_data <- merged_data %>%
  mutate(intt = coalesce(intt.boys, intt.girls))

# Display the merged data with combined intt variable
# print(merged_data)

# Subset to only IDD and intt score
merged_data <- merged_data[, c("IID", "intt")]

# Merge with raw int data
merged_int <- merge(int_raw, merged_data, by = "IID", all = TRUE)
# print(merged_int)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y1 <- c("IID","int","intt", "age")

# Convert the data frame to a data.table
setDT(merged_int)

# Subset the data table and create a new data table
subset_data <- merged_int[, ..variables_to_keep_Y1]

# Rename the columns by appending "_Y1"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y1")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y1"] <- "IID"

# rename data set for merge
int_Y1 <- subset_data

###############################################################################
################################ Year 2 (12.5) ################################
###############################################################################

# Merge Baseline.cbcl with Baseline.Identifiers based on IID to get age
Merged.Y2_cbcl_identifiers <- merge(Y2.cbcl, Y2.Identifiers, by = "IID")

# Then, merge Merged.Y2_cbcl_identifiers with baseline.demo based on IID to get sex variable
Merged.Y2_ID_cbcl <- merge(Merged.Y2_cbcl_identifiers, Baseline.demo, by = "IID")

############### Regress age out of BMI score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Y2_ID_cbcl)[colnames(Merged.Y2_ID_cbcl) == "interview_age"] <- "age"
colnames(Merged.Y2_ID_cbcl)[colnames(Merged.Y2_ID_cbcl) == "cbcl_scr_syn_withdep_r"] <- "int"

# Subset the data
int_raw <- Merged.Y2_ID_cbcl[, c("IID", "age", "sex", "int" )]

# Make data set for boys and girls
boys_data <- int_raw[int_raw$sex == 1, ]
girls_data <- int_raw[int_raw$sex == 2, ]

#################### Regress internalizing scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on int and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
boys_data$intt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress int scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on int and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
girls_data$intt <- residuals

# Display the modified data table with residuals
print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine intt variables and create a new combined intt column
merged_data <- merged_data %>%
  mutate(intt = coalesce(intt.boys, intt.girls))

# Display the merged data with combined intt variable
# print(merged_data)

# Subset to only IDD and intt score
merged_data <- merged_data[, c("IID", "intt")]

# Merge with raw int data
merged_int <- merge(int_raw, merged_data, by = "IID", all = TRUE)
# print(merged_int)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y2 <- c("IID","int","intt", "age")

# Convert the data frame to a data.table
setDT(merged_int)

# Subset the data table and create a new data table
subset_data <- merged_int[, ..variables_to_keep_Y2]

# Rename the columns by appending "_Y2"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y2")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y2"] <- "IID"

# rename data set for merge
int_Y2 <- subset_data

###############################################################################
################################ Year 3 (13.5) ################################
###############################################################################

# Merge Baseline.cbcl with Baseline.Identifiers based on IID to get age
Merged.Y3_cbcl_identifiers <- merge(Y3.cbcl, Y3.Identifiers, by = "IID")

# Then, merge Merged.Y3_cbcl_identifiers with baseline.demo based on IID to get sex variable
Merged.Y3_ID_cbcl <- merge(Merged.Y3_cbcl_identifiers, Baseline.demo, by = "IID")

############### Regress age out of BMI score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Y3_ID_cbcl)[colnames(Merged.Y3_ID_cbcl) == "interview_age"] <- "age"
colnames(Merged.Y3_ID_cbcl)[colnames(Merged.Y3_ID_cbcl) == "cbcl_scr_syn_withdep_r"] <- "int"

# Subset the data
int_raw <- Merged.Y3_ID_cbcl[, c("IID", "age", "sex", "int" )]

# Make data set for boys and girls
boys_data <- int_raw[int_raw$sex == 1, ]
girls_data <- int_raw[int_raw$sex == 2, ]

#################### Regress internalizing scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on int and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = boys_data)
#summary(model)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
boys_data$intt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress int scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on int and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$int), ]

# Fit the linear regression model
model <- lm(int ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into intt var
girls_data$intt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine intt variables and create a new combined intt column
merged_data <- merged_data %>%
  mutate(intt = coalesce(intt.boys, intt.girls))

# Display the merged data with combined intt variable
# print(merged_data)

# Subset to only IDD and intt score
merged_data <- merged_data[, c("IID", "intt")]

# Merge with raw int data
merged_int <- merge(int_raw, merged_data, by = "IID", all = TRUE)
# print(merged_int)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y3 <- c("IID","int","intt", "age")

# Convert the data frame to a data.table
setDT(merged_int)

# Subset the data table and create a new data table
subset_data <- merged_int[, ..variables_to_keep_Y3]

# Rename the columns by appending "_Y3"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y3")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y3"] <- "IID"

# rename data set for merge
int_Y3 <- subset_data

############### Merge all internalizing data sets together  ####################

# Merge all int data sets together
library(data.table)

# List of datasets to merge
int_datasets <- list(int_Baseline, int_Y1, int_Y2, int_Y3)

# Merge all data.tables using full outer join based on IID
int_merged_data <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), int_datasets)

```


### Descriptives (int)


```{r desc 1}
# Internalizing Descriptive Statistics
library(psych)

# Select the variables you want to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3")

# Convert data.table to data frame
data_frame <- as.data.frame(int_merged_data)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

library(ggplot2)

# Create four-panel histogram
library(ggplot2)

# Combine all int variables into a single column
all_int <- c(data_frame$int_Baseline, data_frame$int_Y1, data_frame$int_Y2, data_frame$int_Y3)

# Create a data frame with the combined int values
combined_data <- data.frame(int = all_int, Timepoint = rep(c("Baseline", "Y1", "Y2", "Y3"), each = nrow(data_frame)))

# Create the combined histogram with APA-style formatting
ggplot(combined_data, aes(x = int)) +
  geom_histogram(binwidth = 1, fill = "#0072B2", color = "#0072B2", alpha = 0.7) +
  labs(title = "Histogram Internalizing Depression Symptoms Across Study Timepoints", x = "int", y = "Frequency") +
  facet_wrap(~ Timepoint, scales = "free_x", nrow = 2) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 12),
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.background = element_rect(fill = "#E5E5E5"),
        legend.position = "none")

################################################################################
# install.packages("corrplot")
library(corrplot)
library(dplyr)
library(ggplot2)
library(reshape2)  

# Select the int variables
int_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3")

# Subset the data for the selected int variables
int_data <- data_frame %>%
  select(all_of(int_variables))

# Compute the correlation matrix
cor_matrix <- cor(int_data, use = "complete.obs")
cor_matrix

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 4) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

################################################################################

# Convert to long to examine trajectories
library(tidyr)

# Subset 
long_data <- data_frame[, c("IID", "int_Baseline", "int_Y1", "int_Y2", "int_Y3")]

library(reshape2)

# Convert wide data to long format using melt()
long_data <- melt(data_frame, id.vars = "IID", measure.vars = c("int_Baseline", "int_Y1", "int_Y2", "int_Y3"),
                  variable.name = "Timepoint", value.name = "int")

# Sort the long-format data by IID
sorted_long_data <- long_data %>%
  arrange(IID)

# Print the long-format data
# print(long_data)

library(dplyr)
library(ggplot2)

# Randomly select 1000 unique IIDs
unique_iids <- sorted_long_data %>%
  distinct(IID) %>%
  sample_n(200)  # Select 1000 random IIDs

# Subset the data based on the selected IIDs
subset_data <- sorted_long_data %>%
  filter(IID %in% unique_iids$IID)

# Create a longitudinal plot of int across timepoints
ggplot(subset_data, aes(x = Timepoint, y = int, group = IID, color = IID)) +
  geom_line(size = 1) +
  labs(title = "Longitudinal Plot of Internalizing Depression Symptoms Across Timepoints", x = "Timepoint", y = "int") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 14, hjust = 0.5))
```


## Waist Circumference to Height Ratio (wchr)

```{r buildlist 3}
#Load anthropometric data
anth <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/physical-health/ph_y_anthro.csv", header = TRUE, sep = ",", dec = ".")
#View(anth)
library(psych)
#describe(anth$anthro_waist_cm) #Waist Circumference (inches)
#describe(anth$anthroheightcalc) #Standing Height Average (inches)

#Create key for Identifiers:
anth.varlabels <- anth[1,]

#Remove first row of Identifiers so we are left with only the data:
anth.data <- anth[-1,]

#Rename subject ID
anth.data$IID  <- anth.data[,"src_subject_id"]

#Create 0, 1, 2, 3 assessment data sets
Baseline.anth<-anth.data[anth.data$eventname=="baseline_year_1_arm_1",]
Y1.anth<-anth.data[anth.data$eventname=="1_year_follow_up_y_arm_1",]
Y2.anth<-anth.data[anth.data$eventname=="2_year_follow_up_y_arm_1",]
Y3.anth<-anth.data[anth.data$eventname=="3_year_follow_up_y_arm_1",]

###############################################################################
################################ Baseline (10.5)###############################
###############################################################################

# First, merge Baseline.anth with Baseline.Identifiers based on IID
Merged.Baseline_anth_identifiers <- merge(Baseline.anth, Baseline.Identifiers, by = "IID")

# Then, merge Merged.Baseline_anth_identifiers with baseline.demo based on IID to get sex variable
Merged.Baseline_ID_anth <- merge(Merged.Baseline_anth_identifiers, Baseline.demo, by = "IID")

#Create Waist Circumference to Height Ratio Variable
Merged.Baseline_ID_anth$wchr <- Merged.Baseline_ID_anth$anthro_waist_cm/Merged.Baseline_ID_anth$anthroheightcalc

# Examine extreme scores
library(ggplot2)
summary(Merged.Baseline_ID_anth$wchr)
Merged.Baseline_ID_anth <- Merged.Baseline_ID_anth[Merged.Baseline_ID_anth$wchr >= .20 & Merged.Baseline_ID_anth$wchr <= 1.5, ]
summary(Merged.Baseline_ID_anth$wchr)

histogram_plot <- ggplot(Merged.Baseline_ID_anth, aes(x = wchr)) +
  geom_histogram(binwidth = .05, fill = "blue", color = "black") +
  labs(title = "Histogram of wchr", x = "wchr", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )
print(histogram_plot)

# Regress age out of wchr score by sex separately
library(modelr)
library(tidyr)
library(dplyr)

Merged.Baseline_ID_anth$age <- Merged.Baseline_ID_anth$interview_age

# Subset the data
subset_data <- Merged.Baseline_ID_anth[, c("IID", "age", "sex", "wchr")]
# Make data set for boys and girls
boys_data <- subset_data[subset_data$sex == 1, ]
girls_data <- subset_data[subset_data$sex == 2, ]

######################## Regress wchr scores for boys ###########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on wchr and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
boys_data$wchrt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress wchr scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on wchr and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
girls_data$wchrt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine wchrt variables and create a new combined wchrt column
merged_data <- merged_data %>%
  mutate(wchrt = coalesce(wchrt.boys, wchrt.girls))

# Display the merged data with combined wchrt variable
# print(merged_data)

# Subset to keep only IDD and wchrt score
merged_data <- merged_data[, c("IID", "wchrt")]

# Merge with raw data
merged_wchr <- merge(merged_data, Merged.Baseline_ID_anth, by = "IID", all = TRUE)
# print(merged_wchr)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Baseline <- c("IID","wchr","wchrt","age", "anthro_waist_cm", "anthroheightcalc")

 # Convert the data frame to a data.table
setDT(merged_wchr)

# Subset the data table and create a new data table
subset_data <- merged_wchr[, ..variables_to_keep_Baseline]

# Rename the columns by appending "_Baseline"
colnames(subset_data) <- paste0(colnames(subset_data), "_Baseline")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Baseline"] <- "IID"

# rename data set for merge
wchr_Baseline <- subset_data

###############################################################################
################################ Year 1 (11.5) ################################
###############################################################################

# First, merge Y1.anth with Y1.Identifiers based on IID
Merged.Y1_anth_identifiers <- merge(Y1.anth, Y1.Identifiers, by = "IID")

# Then, merge Merged.Y1_anth_identifiers with Y1.demo based on IID to get sex variable
Merged.Y1_ID_anth <- merge(Merged.Y1_anth_identifiers, Baseline.demo, by = "IID")

#Create Waist Circumference to Height Ratio Variable
Merged.Y1_ID_anth$wchr <- Merged.Y1_ID_anth$anthro_waist_cm/Merged.Y1_ID_anth$anthroheightcalc

# Examine extreme scores
library(ggplot2)
summary(Merged.Y1_ID_anth$wchr)
Merged.Y1_ID_anth <- Merged.Y1_ID_anth[Merged.Y1_ID_anth$wchr >= .20 & Merged.Y1_ID_anth$wchr <= 1.5, ]
summary(Merged.Y1_ID_anth$wchr)

histogram_plot <- ggplot(Merged.Y1_ID_anth, aes(x = wchr)) +
  geom_histogram(binwidth = .05, fill = "blue", color = "black") +
  labs(title = "Histogram of wchr", x = "wchr", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )
print(histogram_plot)

# Regress age out of wchr score by sex separately
library(modelr)
library(tidyr)
library(dplyr)

Merged.Y1_ID_anth$age <- Merged.Y1_ID_anth$interview_age

# Subset the data
subset_data <- Merged.Y1_ID_anth[, c("IID", "age", "sex", "wchr")]
# Make data set for boys and girls
boys_data <- subset_data[subset_data$sex == 1, ]
girls_data <- subset_data[subset_data$sex == 2, ]

######################## Regress wchr scores for boys ###########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on wchr and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
boys_data$wchrt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress wchr scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on wchr and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
girls_data$wchrt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine wchrt variables and create a new combined wchrt column
merged_data <- merged_data %>%
  mutate(wchrt = coalesce(wchrt.boys, wchrt.girls))

# Display the merged data with combined wchrt variable
# print(merged_data)

# Subset to keep only IDD and wchrt score
merged_data <- merged_data[, c("IID", "wchrt")]

# Merge with raw data
merged_wchr <- merge(merged_data, Merged.Y1_ID_anth , by = "IID", all = TRUE)
# print(merged_wchr)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y1 <- c("IID","wchr","wchrt","age","anthro_waist_cm", "anthroheightcalc")

# Convert the data frame to a data.table
setDT(merged_wchr)

# Subset the data table and create a new data table
subset_data <- merged_wchr[, ..variables_to_keep_Y1]

# Rename the columns by appending "_Y1"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y1")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y1"] <- "IID"

# rename data set for merge
wchr_Y1 <- subset_data

###############################################################################
################################ Year 2 (12.5) ################################
###############################################################################

# First, merge Y2.anth with Y2.Identifiers based on IID
Merged.Y2_anth_identifiers <- merge(Y2.anth, Y2.Identifiers, by = "IID")

# Then, merge Merged.Y2_anth_identifiers with Y2.demo based on IID to get sex variable
Merged.Y2_ID_anth <- merge(Merged.Y2_anth_identifiers, Baseline.demo, by = "IID")

#Create Waist Circumference to Height Ratio Variable
Merged.Y2_ID_anth$wchr <- Merged.Y2_ID_anth$anthro_waist_cm/Merged.Y2_ID_anth$anthroheightcalc

# Examine extreme scores
library(ggplot2)
summary(Merged.Y2_ID_anth$wchr)
Merged.Y2_ID_anth <- Merged.Y2_ID_anth %>% filter(wchr >= 0.2)
Merged.Y2_ID_anth <- Merged.Y2_ID_anth %>% filter(wchr <= 1.5)
summary(Merged.Y2_ID_anth$wchr)

histogram_plot <- ggplot(Merged.Y2_ID_anth, aes(x = wchr)) +
  geom_histogram(binwidth = .05, fill = "blue", color = "black") +
  labs(title = "Histogram of wchr", x = "wchr", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )
print(histogram_plot)

# Regress age out of wchr score by sex separately
library(modelr)
library(tidyr)
library(dplyr)

Merged.Y2_ID_anth$age <- Merged.Y2_ID_anth$interview_age

# Subset the data
subset_data <- Merged.Y2_ID_anth[, c("IID", "age", "sex", "wchr")]
# Make data set for boys and girls
boys_data <- subset_data[subset_data$sex == 1, ]
girls_data <- subset_data[subset_data$sex == 2, ]

######################## Regress wchr scores for boys ###########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on wchr and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
boys_data$wchrt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress wchr scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on wchr and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
girls_data$wchrt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine wchrt variables and create a new combined wchrt column
merged_data <- merged_data %>%
  mutate(wchrt = coalesce(wchrt.boys, wchrt.girls))

# Display the merged data with combined wchrt variable
# print(merged_data)

# Subset to keep only IDD and wchrt score
merged_data <- merged_data[, c("IID","wchrt")]

# Merge with CDC calculated data set
merged_wchr <- merge(merged_data, Merged.Y2_ID_anth , by = "IID", all = TRUE)
# print(merged_wchr)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y2 <- c("IID","wchr","wchrt","age","anthro_waist_cm", "anthroheightcalc")

# Convert the data frame to a data.table
setDT(merged_wchr)

# Subset the data table and create a new data table
subset_data <- merged_wchr[, ..variables_to_keep_Y2]

# Rename the columns by appending "_Y2"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y2")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y2"] <- "IID"

# rename data set for merge
wchr_Y2 <- subset_data

###############################################################################
################################ Year 3 (13.5) ################################
###############################################################################


# First, merge Y3.anth with Y3.Identifiers based on IID
Merged.Y3_anth_identifiers <- merge(Y3.anth, Y3.Identifiers, by = "IID")

# Then, merge Merged.Y3_anth_identifiers with Y3.demo based on IID to get sex variable
Merged.Y3_ID_anth <- merge(Merged.Y3_anth_identifiers, Baseline.demo, by = "IID")

#Create Waist Circumference to Height Ratio Variable
Merged.Y3_ID_anth$wchr <- Merged.Y3_ID_anth$anthro_waist_cm/Merged.Y3_ID_anth$anthroheightcalc

# Examine extreme scores
library(ggplot2)
summary(Merged.Y3_ID_anth$wchr)
Merged.Y3_ID_anth <- Merged.Y3_ID_anth %>% filter(wchr >= 0.2)
Merged.Y3_ID_anth <- Merged.Y3_ID_anth %>% filter(wchr <= 1.5)
summary(Merged.Y3_ID_anth$wchr)

histogram_plot <- ggplot(Merged.Y3_ID_anth, aes(x = wchr)) +
  geom_histogram(binwidth = .05, fill = "blue", color = "black") +
  labs(title = "Histogram of wchr", x = "wchr", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )
print(histogram_plot)

# Regress age out of wchr score by sex separately
library(modelr)
library(tidyr)
library(dplyr)

Merged.Y3_ID_anth$age <- Merged.Y3_ID_anth$interview_age

# Subset the data
subset_data <- Merged.Y3_ID_anth[, c("IID", "age", "sex", "wchr")]
# Make data set for boys and girls
boys_data <- subset_data[subset_data$sex == 1, ]
girls_data <- subset_data[subset_data$sex == 2, ]

######################## Regress wchr scores for boys ###########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on wchr and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
boys_data$wchrt <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress wchr scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on wchr and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$wchr), ]

# Fit the linear regression model
model <- lm(wchr ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals into wchrt var
girls_data$wchrt <- residuals

# Display the modified data table with residuals
# print(girls_data)

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine wchrt variables and create a new combined wchrt column
merged_data <- merged_data %>%
  mutate(wchrt = coalesce(wchrt.boys, wchrt.girls))

# Display the merged data with combined wchrt variable
# print(merged_data)

# Subset to keep only IDD and wchrt score
merged_data <- merged_data[, c("IID", "wchrt")]

# Merge with raw data
merged_wchr <- merge(merged_data, Merged.Y3_ID_anth , by = "IID", all = TRUE)
# print(merged_wchr)

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y3 <- c("IID","wchr","wchrt","age","anthro_waist_cm", "anthroheightcalc")

# Convert the data frame to a data.table
setDT(merged_wchr)

# Subset the data table and create a new data table
subset_data <- merged_wchr[, ..variables_to_keep_Y3]

# Rename the columns by appending "_Y3"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y3")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y3"] <- "IID"

# rename data set for merge
wchr_Y3 <- subset_data

##### Merge all Waist Height to Weight Ratio Together data sets together  ######

# Merge all wchr data sets together
library(data.table)

# List of datasets to merge
wchr_datasets <- list(wchr_Baseline, wchr_Y1, wchr_Y2, wchr_Y3)

# Merge all data.tables using full outer join based on IID
wchr_merged_data <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), wchr_datasets)

```

### Descriptives (wchr)

```{r desc 2}
# wchr Descriptive Statistics
library(psych)

# Select the variables you want to describe
variables_to_describe <- c("age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3")

# Convert data.table to data frame
data_frame <- as.data.frame(wchr_merged_data)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Create four-panel histogram
library(ggplot2)

# Combine all wchr variables into a single column
all_wchr <- c(data_frame$wchr_Baseline, data_frame$wchr_Y1, data_frame$wchr_Y2, data_frame$wchr_Y3)

# Create a data frame with the combined wchr values
combined_data <- data.frame(wchr = all_wchr, Timepoint = rep(c("Baseline", "Y1", "Y2", "Y3"), each = nrow(data_frame)))

# Create the combined histogram with APA-style formatting
ggplot(combined_data, aes(x = wchr)) +
  geom_histogram(binwidth = .5, fill = "#0072B2", color = "#0072B2", alpha = 0.7) +
  labs(title = "Histogram of Combined wchr", x = "wchr", y = "Frequency") +
  facet_wrap(~ Timepoint, scales = "free_x", nrow = 2) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 12),
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.background = element_rect(fill = "#E5E5E5"),
        legend.position = "none")

################################################################################
# install.packages("corrplot")
library(corrplot)
library(dplyr)
library(ggplot2)
library(reshape2)  

# Select the wchr variables
wchr_variables <- c("wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3")

# Subset the data for the selected wchr variables
wchr_data <- data_frame %>%
  select(all_of(wchr_variables))

# Compute the correlation matrix
cor_matrix <- cor(wchr_data, use = "complete.obs")
cor_matrix

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 4) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

################################################################################

# Convert to long to examine trajectories
library(tidyr)

# Subset 
long_data <- data_frame[, c("IID", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3")]

library(reshape2)

# Convert wide data to long format using melt()
long_data <- melt(data_frame, id.vars = "IID", measure.vars = c("wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3"),
                  variable.name = "Timepoint", value.name = "wchr")

# Sort the long-format data by IID
sorted_long_data <- long_data %>%
  arrange(IID)

# Print the long-format data
# print(long_data)

library(dplyr)
library(ggplot2)

# Randomly select 1000 unique IIDs
unique_iids <- sorted_long_data %>%
  distinct(IID) %>%
  sample_n(200)  # Select 1000 random IIDs

# Subset the data based on the selected IIDs
subset_data <- sorted_long_data %>%
  filter(IID %in% unique_iids$IID)

# Create a longitudinal plot of wchr across timepoints
ggplot(subset_data, aes(x = Timepoint, y = wchr, group = IID, color = IID)) +
  geom_line(size = 1) +
  labs(title = "Longitudinal Plot of wchr Across Timepoint (Subset)", x = "Timepoint", y = "wchr") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 14, hjust = 0.5))

```


## Puberty - Pubertal Development Scale (pub)

```{r buildlist 4}

#Load PDS data
pub <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/physical-health/ph_y_pds.csv", header = TRUE, sep = ",", dec = ".")
#View(pds)

describe(pub$pds_y_ss_female_category) 
describe(pub$pds_y_ss_male_category) 

describe(pub$pds_y_ss_female_category_2) 
describe(pub$pds_y_ss_male_cat_2) 

#Create key for Identifiers:
pub.varlabels <- pub[1,]

#Remove first row of Identifiers so we are left with only the data:
pub.data <- pub[-1,]

#Rename subject ID
pub.data$IID  <- pub.data[,"src_subject_id"]

#Create 0, 1, 2,3 assessment data sets
Baseline.pub<-pub.data[pub.data$eventname=="baseline_year_1_arm_1",]
Y1.pub<-pub.data[pub.data$eventname=="1_year_follow_up_y_arm_1",]
Y2.pub<-pub.data[pub.data$eventname=="2_year_follow_up_y_arm_1",]
Y3.pub<-pub.data[pub.data$eventname=="3_year_follow_up_y_arm_1",]

###############################################################################
################################ Baseline (10.5)###############################
###############################################################################

# Merge Baseline.pub with Baseline.Identifiers based on IID to get age
Merged.Baseline_pub_identifiers <- merge(Baseline.pub, Baseline.Identifiers, by = "IID")

# Then, merge Merged.Baseline_pub_identifiers with baseline.demo based on IID to get sex variable
Merged.Baseline_ID_pub <- merge(Merged.Baseline_pub_identifiers, Baseline.demo, by = "IID")

############### Regress age out of BMI score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Baseline_ID_pub)[colnames(Merged.Baseline_ID_pub) == "interview_age"] <- "age"
colnames(Merged.Baseline_ID_pub)[colnames(Merged.Baseline_ID_pub) == "pds_y_ss_female_category"] <- "pub_girls"
colnames(Merged.Baseline_ID_pub)[colnames(Merged.Baseline_ID_pub) == "pds_y_ss_male_category"] <- "pub_boys"

# Subset the data
pub_subset <- Merged.Baseline_ID_pub[, c("IID", "age", "sex", "pub_girls", "pub_boys" )]

# Make data set for boys and girls
boys_data <- pub_subset[pub_subset$sex == 1, ]
girls_data <- pub_subset[pub_subset$sex == 2, ]

#################### Regress PDS scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on pub and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$pub_boys), ]

# Fit the linear regression model
model <- lm(pub_boys ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
boys_data$pubt_boys <- residuals

# Display the modified data table with residuals
print(boys_data)

######################## Regress pub scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on pub and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$pub_girls), ]

# Fit the linear regression model
model <- lm(pub_girls ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
girls_data$pubt_girls <- residuals

# Display the modified data table with residuals
# print(girls_data)

################################################################################

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine pubt variables and create a new combined pubt column
merged_data <- merged_data %>%
  mutate(pubt = coalesce(pubt_boys, pubt_girls))

# Display the merged data with combined pubt variable
# print(merged_data)

# Subset to only IDD and pubt score
merged_data <- merged_data[, c("IID", "pubt")]

# Merge with raw pub data
merged_pub <- merge(pub_subset, merged_data, by = "IID", all = TRUE)
# print(merged_pub)

# Combine pub boys and girls variables and create a new combined pub column
merged_pub <- merged_pub %>%
  mutate(pub = coalesce(pub_boys, pub_girls))

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Baseline <- c("IID","pub", "pubt", "age")

# Convert the data frame to a data.table
setDT(merged_pub)

# Subset the data table and create a new data table
subset_data <- merged_pub[, ..variables_to_keep_Baseline]

# Rename the columns by appending "_Baseline"
colnames(subset_data) <- paste0(colnames(subset_data), "_Baseline")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Baseline"] <- "IID"

# rename data set for merge
pub_Baseline <- subset_data

###############################################################################
################################ Year 1 (11.5) ################################
###############################################################################

# Merge Y1.pub with Baseline.Identifiers based on IID to get age
Merged.Y1_pub_identifiers <- merge(Y1.pub, Baseline.Identifiers, by = "IID")

# Then, merge Merged.Baseline_pub_identifiers with baseline.demo based on IID to get sex variable
Merged.Y1_ID_pub <- merge(Merged.Y1_pub_identifiers, Baseline.demo, by = "IID")

############### Regress age out of PDS score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# Rename variables for code below
colnames(Merged.Y1_ID_pub)[colnames(Merged.Y1_ID_pub) == "interview_age"] <- "age"
colnames(Merged.Y1_ID_pub)[colnames(Merged.Y1_ID_pub) == "pds_y_ss_female_category"] <- "pub_girls"
colnames(Merged.Y1_ID_pub)[colnames(Merged.Y1_ID_pub) == "pds_y_ss_male_category"] <- "pub_boys"

# Subset the data
pub_subset <- Merged.Y1_ID_pub[, c("IID", "age", "sex", "pub_girls", "pub_boys" )]

# Make data set for boys and girls
boys_data <- pub_subset[pub_subset$sex == 1, ]
girls_data <- pub_subset[pub_subset$sex == 2, ]

#################### Regress PDS scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on pub and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$pub_boys), ]

# Fit the linear regression model
model <- lm(pub_boys ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
boys_data$pubt_boys <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress pub scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on pub and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$pub_girls), ]

# Fit the linear regression model
model <- lm(pub_girls ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
girls_data$pubt_girls <- residuals

# Display the modified data table with residuals
# print(girls_data)

################################################################################

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine pubt variables and create a new combined pubt column
merged_data <- merged_data %>%
  mutate(pubt = coalesce(pubt_boys, pubt_girls))

# Display the merged data with combined pubt variable
# print(merged_data)

# Subset to only IDD and pubt score
merged_data <- merged_data[, c("IID", "pubt")]

# Merge with raw pub data
merged_pub <- merge(pub_subset, merged_data, by = "IID", all = TRUE)
# print(merged_pub)

# Combine pub boys and girls variables and create a new combined pub column
merged_pub <- merged_pub %>%
  mutate(pub = coalesce(pub_boys, pub_girls))

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y1 <- c("IID","pub", "pubt", "age")

# Convert the data frame to a data.table
setDT(merged_pub)

# Subset the data table and create a new data table
subset_data <- merged_pub[, ..variables_to_keep_Y1]

# Rename the columns by appending "_Y1"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y1")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y1"] <- "IID"

# rename data set for merge
pub_Y1 <- subset_data

###############################################################################
################################ Year 2 (12.5) ################################
###############################################################################

# Merge Y2.pub with Baseline.Identifiers based on IID to get age
Merged.Y2_pub_identifiers <- merge(Y2.pub, Y2.Identifiers, by = "IID")

# Then, merge Merged.Baseline_pub_identifiers with baseline.demo based on IID to get sex variable
Merged.Y2_ID_pub <- merge(Merged.Y2_pub_identifiers, Baseline.demo, by = "IID")

############### Regress age out of PDS score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

#NOTE USING _2 PDS score since massive missing on one without _2 NEED TO KNOW DIFFERENCES

# Rename variables for code below
colnames(Merged.Y2_ID_pub)[colnames(Merged.Y2_ID_pub) == "interview_age"] <- "age"
colnames(Merged.Y2_ID_pub)[colnames(Merged.Y2_ID_pub) == "pds_y_ss_female_category_2"] <- "pub_girls"
colnames(Merged.Y2_ID_pub)[colnames(Merged.Y2_ID_pub) == "pds_y_ss_male_cat_2"] <- "pub_boys"

#summary(Merged.Y2_ID_pub$pub_boys)

# Subset the data
pub_subset <- Merged.Y2_ID_pub[, c("IID", "age", "sex", "pub_girls", "pub_boys")]

# Make data set for boys and girls
boys_data <- pub_subset[pub_subset$sex == 1, ]
girls_data <- pub_subset[pub_subset$sex == 2, ]

#################### Regress PDS scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on pub and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$pub_boys), ]

# Fit the linear regression model
model <- lm(pub_boys ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
boys_data$pubt_boys <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress pub scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on pub and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$pub_girls), ]

# Fit the linear regression model
model <- lm(pub_girls ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
girls_data$pubt_girls <- residuals

# Display the modified data table with residuals
# print(girls_data)

################################################################################

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine pubt variables and create a new combined pubt column
merged_data <- merged_data %>%
  mutate(pubt = coalesce(pubt_boys, pubt_girls))

# Display the merged data with combined pubt variable
print(merged_data)

# Subset to only IDD and pubt score
merged_data <- merged_data[, c("IID", "pubt")]

# Merge with raw pub data
merged_pub <- merge(pub_subset, merged_data, by = "IID", all = TRUE)
# print(merged_pub)

# Combine pub boys and girls variables and create a new combined pub column
merged_pub <- merged_pub %>%
  mutate(pub = coalesce(pub_boys, pub_girls))

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y2 <- c("IID","pub", "pubt", "age")

# Convert the data frame to a data.table
setDT(merged_pub)

# Subset the data table and create a new data table
subset_data <- merged_pub[, ..variables_to_keep_Y2]

# Rename the columns by appending "_Y2"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y2")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y2"] <- "IID"

# rename data set for merge
pub_Y2 <- subset_data

###############################################################################
################################ Year 3 (13.5) ################################
###############################################################################

# Merge Y3.pub with Baseline.Identifiers based on IID to get age
Merged.Y3_pub_identifiers <- merge(Y3.pub, Baseline.Identifiers, by = "IID")

# Then, merge Merged.Baseline_pub_identifiers with baseline.demo based on IID to get sex variable
Merged.Y3_ID_pub <- merge(Merged.Y3_pub_identifiers, Baseline.demo, by = "IID")

############### Regress age out of BMI score by sex separately #################
library(modelr)
library(tidyr)
library(dplyr)

# summary(Merged.Y3_ID_pub$pds_y_ss_female_category)
# summary(Merged.Y3_ID_pub$pds_y_ss_female_category_2) #Use this one

# summary(Merged.Y3_ID_pub$pds_y_ss_male_category)
# summary(Merged.Y3_ID_pub$pds_y_ss_male_cat_2) #Use this one

# Rename variables for code below
colnames(Merged.Y3_ID_pub)[colnames(Merged.Y3_ID_pub) == "interview_age"] <- "age"
colnames(Merged.Y3_ID_pub)[colnames(Merged.Y3_ID_pub) == "pds_y_ss_female_category_2"] <- "pub_girls"
colnames(Merged.Y3_ID_pub)[colnames(Merged.Y3_ID_pub) == "pds_y_ss_male_cat_2"] <- "pub_boys"

# Subset the data
pub_subset <- Merged.Y3_ID_pub[, c("IID", "age", "sex", "pub_girls", "pub_boys" )]

# Make data set for boys and girls
boys_data <- pub_subset[pub_subset$sex == 1, ]
girls_data <- pub_subset[pub_subset$sex == 2, ]

#################### Regress PDS scores for boys #####################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(boys_data)

# Drop cases missing on pub and age
boys_data <- boys_data[!is.na(boys_data$age) & !is.na(boys_data$pub_boys), ]

# Fit the linear regression model
model <- lm(pub_boys ~ age, data = boys_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
boys_data$pubt_boys <- residuals

# Display the modified data table with residuals
# print(boys_data)

######################## Regress pub scores for girls ##########################

# Convert data.table to data.frame for linear regression
data_frame <- as.data.frame(girls_data)

# Drop cases missing on pub and age
girls_data <- girls_data[!is.na(girls_data$age) & !is.na(girls_data$pub_girls), ]

# Fit the linear regression model
model <- lm(pub_girls ~ age, data = girls_data)

# Calculate residuals
residuals <- residuals(model)

# Save residuals pubo pubt var
girls_data$pubt_girls <- residuals

# Display the modified data table with residuals
# print(girls_data)

################################################################################

# Merge Data
merged_data <- merge(boys_data, girls_data, by = "IID", all = TRUE, suffixes = c(".boys", ".girls"))

# Combine pubt variables and create a new combined pubt column
merged_data <- merged_data %>%
  mutate(pubt = coalesce(pubt_boys, pubt_girls))

# Display the merged data with combined pubt variable
# print(merged_data)

# Subset to only IDD and pubt score
merged_data <- merged_data[, c("IID", "pubt")]

# Merge with raw pub data
merged_pub <- merge(pub_subset, merged_data, by = "IID", all = TRUE)
# print(merged_pub)

# Combine pub boys and girls variables and create a new combined pub column
merged_pub <- merged_pub %>%
  mutate(pub = coalesce(pub_boys, pub_girls))

# Rename variables to keep in each assessment data set
library(data.table)
variables_to_keep_Y3 <- c("IID","pub", "pubt", "age")

# Convert the data frame to a data.table
setDT(merged_pub)

# Subset the data table and create a new data table
subset_data <- merged_pub[, ..variables_to_keep_Y3]

# Rename the columns by appending "_Y3"
colnames(subset_data) <- paste0(colnames(subset_data), "_Y3")

# Rename IID for merge
colnames(subset_data)[colnames(subset_data) == "IID_Y3"] <- "IID"

# rename data set for merge
pub_Y3 <- subset_data

############### Merge all PDS data sets together  ####################

# Merge all pub data sets together
library(data.table)

# List of datasets to merge
pub_datasets <- list(pub_Baseline, pub_Y1, pub_Y2, pub_Y3)

# Merge all data.tables using full outer join based on IID
pub_merged_data <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), pub_datasets)

```

### Descriptives

```{r desc 3}
# Puberty Descriptive Statistics
library(psych)

# Select the variables you want to describe
variables_to_describe <- c("age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3")

# Convert data.table to data frame
data_frame <- as.data.frame(pub_merged_data)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Create four-panel histogram
library(ggplot2)

# Combine all pub variables pubo a single column
all_pub <- c(data_frame$pub_Baseline, data_frame$pub_Y1, data_frame$pub_Y2, data_frame$pub_Y3)

# Create a data frame with the combined pub values
combined_data <- data.frame(pub = all_pub, Timepopub = rep(c("Baseline", "Y1", "Y2", "Y3"), each = nrow(data_frame)))

# Create the combined histogram with APA-style formatting
ggplot(combined_data, aes(x = pub)) +
  geom_histogram(binwidth = 1, fill = "#0072B2", color = "#0072B2", alpha = 0.7) +
  labs(title = "Histogram of Combined pub", x = "pub", y = "Frequency") +
  facet_wrap(~ Timepopub, scales = "free_x", nrow = 2) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 12),
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.background = element_rect(fill = "#E5E5E5"),
        legend.position = "none")

################################################################################
# install.packages("corrplot")
library(corrplot)
library(dplyr)
library(ggplot2)
library(reshape2)  

# Select the pub variables
pub_variables <- c("pub_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Subset the data for the selected pub variables
pub_data <- data_frame %>%
  select(all_of(pub_variables))

# Compute the correlation matrix
cor_matrix <- cor(pub_data, use = "complete.obs")
cor_matrix

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 4) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

################################################################################

# Convert to long to examine trajectories
library(tidyr)

# Subset 
long_data <- data_frame[, c("IID", "pub_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")]

library(reshape2)

# Convert wide data to long format using melt()
long_data <- melt(data_frame, id.vars = "IID", measure.vars = c("pub_Baseline", "pub_Y1", "pub_Y2", "pub_Y3"),
                  variable.name = "Timepopub", value.name = "pub")

# Sort the long-format data by IID
sorted_long_data <- long_data %>%
  arrange(IID)

# Print the long-format data
# print(long_data)

library(dplyr)
library(ggplot2)

# Randomly select 1000 unique IIDs
unique_iids <- sorted_long_data %>%
  distinct(IID) %>%
  sample_n(500)  # Select 1000 random IIDs

# Subset the data based on the selected IIDs
subset_data <- sorted_long_data %>%
  filter(IID %in% unique_iids$IID)

# Create a longitudinal plot of pub across timepopubs
ggplot(subset_data, aes(x = Timepopub, y = pub, group = IID, color = IID)) +
  geom_line(size = 1) +
  labs(title = "Longitudinal Plot of pub Across Time (Subset)", x = "Timepoint", y = "pub") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 14, hjust = 0.5))
```

## Covariates 

```{r cov}
library(psych)
# Load parent psychopathology covariate data 
abcl <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/mental-health/mh_p_abcl.csv", header = TRUE, sep = ",", dec = ".")
asr <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/mental-health/mh_p_asr.csv", header = TRUE, sep = ",", dec = ".")
# View(abcl)
# View(asr)

# Remove first row of Identifiers so we are left with only the data:
abcl.data <- abcl[-1,]
asr.data <- asr[-1,]

# Rename subject ID
abcl.data$IID  <- abcl.data[,"src_subject_id"]
asr.data$IID  <- asr.data[,"src_subject_id"]

# Create Y2 assessment data sets for parent psychopathology (Other Parent)
Y2.abcl<-abcl.data[abcl.data$eventname=="2_year_follow_up_y_arm_1",]

# Create 0, 2 assessment data sets for parent psychopathology (Self report)
Baseline.asr<-asr.data[asr.data$eventname=="baseline_year_1_arm_1",]
Y2.asr<-asr.data[asr.data$eventname=="2_year_follow_up_y_arm_1",]

# Rename variables for merge
Baseline.asr$asr_scr_internal_r_b <- Baseline.asr$asr_scr_internal_r
Y2.asr$asr_scr_internal_r_2 <- Y2.asr$asr_scr_internal_r

# Merge 0, 2 assessment data parent psychopathology (Self report)
Merged.asr_Baseline_Y2 <- merge(Baseline.asr, Y2.asr, by = "IID")

# Calculate correlation
correlation <- cor(Merged.asr_Baseline_Y2$asr_scr_internal_r_b, Merged.asr_Baseline_Y2$asr_scr_internal_r_2, use = "pairwise.complete.obs")
print(correlation)

library(data.table)
# Keep subset for merge
variables_to_keep <- c("IID","asr_scr_internal_r_b","asr_scr_internal_r_2")

# Convert the data frame to a data.table
setDT(Merged.asr_Baseline_Y2)

# Subset the data table and create a new data table
Merged.asr_Baseline_Y2_subset <- Merged.asr_Baseline_Y2[, ..variables_to_keep]

# Create average asr variable
Merged.asr_Baseline_Y2_subset[, asr_int_ave := (asr_scr_internal_r_b + asr_scr_internal_r_2) / 2]

# Keep subset for acbl data
variables_to_keep <- c("IID","abcl_scr_prob_internal_r")

# Convert the data frame to a data.table
setDT(Y2.abcl)

# Subset the data table and create a new data table
Y2.abcl_subset <- Y2.abcl[, ..variables_to_keep]

# Merge asr abcl data
Merged.asr_abcl <- merge(Merged.asr_Baseline_Y2_subset, Y2.abcl_subset, by = "IID")

# Average together averaged parent internalizing self report with report on other parent
Merged.asr_abcl[, int_p_ave := (asr_int_ave + abcl_scr_prob_internal_r) / 2]

# Descriptive statistics

# Calculate correlation
correlation <- cor(Merged.asr_abcl$asr_int_ave, Merged.asr_abcl$abcl_scr_prob_internal_r, use = "pairwise.complete.obs")
print(correlation)

famc <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/culture-environment/ce_p_fes.csv", header = TRUE, sep = ",", dec = ".")

#View(famc)
describe(famc$fes_p_ss_fc) 
summary(famc$fes_p_ss_fc)

#Create key for Identifiers:
famc.varlabels <- famc[1,]

#Remove first row of Identifiers so we are left with only the data:
famc.data <- famc[-1,]

#Rename subject ID
famc.data$IID  <- famc.data[,"src_subject_id"]

#Create 0, 1, 2,3 assessment data sets
Baseline.famc<-famc.data[famc.data$eventname=="baseline_year_1_arm_1",]
Y1.famc<-famc.data[famc.data$eventname=="1_year_follow_up_y_arm_1",]
Y2.famc<-famc.data[famc.data$eventname=="2_year_follow_up_y_arm_1",]
Y3.famc<-famc.data[famc.data$eventname=="3_year_follow_up_y_arm_1",]

# Rename variables for merge
Baseline.famc$fes_p_ss_fc_b <- Baseline.famc$fes_p_ss_fc
Y1.famc$fes_p_ss_fc_1 <- Y1.famc$fes_p_ss_fc
Y2.famc$fes_p_ss_fc_2 <- Y2.famc$fes_p_ss_fc
Y3.famc$fes_p_ss_fc_3 <- Y3.famc$fes_p_ss_fc

# Merge all family conflict data sets together
library(data.table)

# List of datasets to merge
famc_datasets <- list(Baseline.famc, Y1.famc, Y2.famc, Y3.famc)

# Merge all data.tables using full outer join based on IID
famc_merged_data <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), famc_datasets)

# Select the pub variables
famc_variables <- c("fes_p_ss_fc_b","fes_p_ss_fc_1", "fes_p_ss_fc_2", "fes_p_ss_fc_3")

# Subset the data for the selected pub variables
famc_data_corr <- famc_merged_data %>%
  select(all_of(famc_variables))

# Compute the correlation matrix
cor_matrix <- cor(famc_data_corr, use = "pairwise.complete.obs")
cor_matrix

# Keep subset for merge
variables_to_keep <- c("IID","fes_p_ss_fc_b","fes_p_ss_fc_1", "fes_p_ss_fc_2", "fes_p_ss_fc_3")

# Convert the data frame to a data.table
setDT(famc_merged_data)

# Subset the data table and create a new data table
famc_merged_data_subset <- famc_merged_data[, ..variables_to_keep]

# Merge family conflict together across waves
famc_merged_data_subset[, famc_ave := rowSums(.SD, na.rm = TRUE) / 4, .SDcols = c("fes_p_ss_fc_b", "fes_p_ss_fc_1", "fes_p_ss_fc_2", "fes_p_ss_fc_3")]

# Keep subset for merge
variables_to_keep <- c("IID","famc_ave")

# Subset the data table and create a new data table
famc_merged_data_subset <- famc_merged_data_subset[, ..variables_to_keep]

# Child specific covariates

# Birth weight
birth <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/physical-health/ph_p_dhx.csv", header = TRUE, sep = ",", dec = ".")

# Delete cases where 'eventname' is "4_year_follow_up_y_arm_1"
birth_baseline <- birth[birth$eventname != "4_year_follow_up_y_arm_1", ]

#Create key for Identifiers:
birth.varlabels <- birth_baseline[1,]

#Remove first row of Identifiers so we are left with only the data:
birth_baseline <- birth_baseline[-1,]

#Rename subject ID
birth_baseline$IID  <- birth_baseline[,"src_subject_id"]

# Keep subset for merge
variables_to_keep <- c("IID","birth_weight_lbs","birth_weight_oz", "devhx_3_p", "devhx_9_alchohol_avg", "devhx_9_alcohol", "devhx_9_cigs_per_day", "devhx_9_tobacco", "devhx_9_marijuana_amt", "devhx_9_marijuana")

# Convert the data frame to a data.table
setDT(birth_baseline)

# Subset the data table and create a new data table
birth.data_subset <- birth_baseline[, ..variables_to_keep]

# Convert ounces to pounds (1 lb = 16 oz) and create birth.data weight variable
birth.data_subset$bw_lbs <- birth.data_subset$birth_weight_lbs + birth.data_subset$birth_weight_oz / 16
describe(birth.data_subset$bw_lbs)
hist(birth.data_subset$bw_lbs, 
     main = "Histogram of birth.data Weight", # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 5)   

# Maternal age 
birth.data_subset$matage <- birth.data_subset$devhx_3_p
describe(birth.data_subset$matage)
hist(birth.data_subset$matage, 
     main = "Histogram of Maternal Age", # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 10) 

# Alcohol use
birth.data_subset$devhx_9_alchohol_avg <- ifelse(birth.data_subset$devhx_9_alcohol == 0, 0,
                                     ifelse(birth.data_subset$devhx_9_alcohol == 999, NA,
                                     no = birth.data_subset$devhx_9_alchohol_avg))

birth.data_subset$matalc_ave <- birth.data_subset$devhx_9_alchohol_avg
describe(birth.data_subset$matalc_ave)
freq_devhx_9_alchohol_avg <- table(birth.data_subset$devhx_9_alchohol_avg)
print(freq_devhx_9_alchohol_avg)
hist(birth.data_subset$matalc_ave, 
     main = "Histogram of Average Drinks Per Week",  # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 10)

# Cigarette use

# Recode devhx_9_cigs_per_day
birth.data_subset$devhx_9_cigs_per_day <- ifelse(birth.data_subset$devhx_9_tobacco == 0, 0,
                                     ifelse(birth.data_subset$devhx_9_tobacco == 999, NA,
                                     no = birth.data_subset$devhx_9_cigs_per_day))

birth.data_subset$matcig_ave <- birth.data_subset$devhx_9_cigs_per_day
describe(birth.data_subset$matcig_ave)
hist(birth.data_subset$matcig_ave, 
     main = "Histogram of Average Cigarette Use Per Day",  # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 10)

# Marijuana
birth.data_subset$devhx_9_marijuana_amt <- ifelse(birth.data_subset$devhx_9_marijuana == 0, 0,
                                     ifelse(birth.data_subset$devhx_9_marijuana == 999, NA,
                                     no = birth.data_subset$devhx_9_marijuana_amt))

birth.data_subset$matmar_ave <- birth.data_subset$devhx_9_marijuana_amt
describe(birth.data_subset$matmar_ave)
hist(birth.data_subset$matmar_ave, 
     main = "Histogram of Average Marijuana Use Per Day",  # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 10)

# General socioeconomic status latent factor
ses <- read.csv("C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Data/abcd-data-release-5.1/core/abcd-general/abcd_y_lf.csv", header = TRUE, sep = ",", dec = ".")

#Create key for Identifiers:
ses.varlabels <- ses[1,]

#Remove first row of Identifiers so we are left with only the data:
ses.data <- ses[-1,]

#Rename subject ID
ses.data$IID  <- ses.data[,"src_subject_id"]

# Keep subset for merge
variables_to_keep <- c("IID","latent_factor_ss_general_ses")

# Convert the data frame to a data.table
setDT(ses.data)

# Subset the data table and create a new data table
ses.data_subset <- ses.data[, ..variables_to_keep]

ses.data_subset$ses_lt <- ses.data_subset$latent_factor_ss_general_ses

describe(ses.data_subset$ses_lt)
hist(ses.data_subset$ses_lt, 
     main = "Histogram of SES Latent Factor Score",  # Title of the histogram
     xlab = "Value",                     # Label for the x-axis
     ylab = "Frequency",                 # Label for the y-axis
     col = "blue",                       # Color of the bars
     border = "black",                   # Color of the bar borders
     breaks = 10)   

################### Merge all covariate data sets together  ####################
library(data.table)

# List of datasets to merge
cov_datasets <- list(Merged.asr_abcl, famc_merged_data_subset, birth.data_subset, ses.data_subset)

# Merge all data.tables using full outer join based on IID
cov_merged_data <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), cov_datasets)

```

## Merge

Note that wave 4 WCHR still has a lot of missingness.


```{r merge}
# Merge all constructed data set for each phenotype together
library(data.table)

# Drop redundant age variables before merge
library(dplyr)

# List of variables to drop
variables_to_drop <- c("age_Baseline", "age_Y1", "age_Y2", "age_Y3")

# Drop the specified variables from the wchr dataset
wchr_merged_data <- wchr_merged_data %>%
  select(-all_of(variables_to_drop))

# Drop the specified variables from the puberty dataset
pub_merged_data <- pub_merged_data %>%
  select(-all_of(variables_to_drop))

# List of datasets to merge
all_datasets <- list(int_merged_data, wchr_merged_data, pub_merged_data, cov_merged_data, Baseline.demo)

# Merge all data.tables using full outer join based on IID
all_merged <- Reduce(function(x, y) merge(x, y, by = "IID", all = TRUE), all_datasets)

# Find duplicate IDs
# duplicate_ids <- all_merged$IID[duplicated(all_merged$IID)]
# Display the duplicate IDs
# print(duplicate_ids)

```

## Associations (Whole Sample)

```{r corrs}
# install.packages("Hmisc")
# library("Hmisc")
library("psych")

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```


## Associations (White sample)

```{r corrs genrel}

# subset data to just White participants
subset_all_merged <- all_merged[all_merged$race3 == 1, ]

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(subset_all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

## Associations (Black sample)

```{r}
# subset data to just White participants
subset_all_merged <- all_merged[all_merged$race3 == 2, ]

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(subset_all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```

## Associations (Hispanic sample)

```{r}

# subset data to just White participants
subset_all_merged <- all_merged[all_merged$race3 == 3, ]

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(subset_all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```

## Associations (Boys)

```{r}

# subset data to just White participants
subset_all_merged <- all_merged[all_merged$sex == 1, ]

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(subset_all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

## Associations (Girls)

```{r}

# subset data to just White participants
subset_all_merged <- all_merged[all_merged$sex == 2, ]

# Examining cross phenotype associations

# Select the variables to describe
variables_to_describe <- c("age_Baseline", "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "age_Baseline", "wchr_Baseline", "wchrt_Baseline",
                           "age_Y1", "wchr_Y1", "wchrt_Y1",
                           "age_Y2", "wchr_Y2", "wchrt_Y2",
                           "age_Y3", "wchr_Y3", "wchrt_Y3",
                           "age_Baseline", "pub_Baseline", "pubt_Baseline",
                           "age_Y1", "pub_Y1", "pubt_Y1",
                           "age_Y2", "pub_Y2", "pubt_Y2",
                           "age_Y3", "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")

# Convert data.table to data frame
data_frame <- as.data.frame(subset_all_merged)

# Use the describe() function to obtain descriptive statistics
variable_descriptions <- describe(data_frame[variables_to_describe])

# Print the descriptive statistics
print(variable_descriptions)

# Select the variables
all_variables <- c("int_Baseline", "int_Y1", "int_Y2", "int_Y3","int_Baseline", "wchr_Baseline", "wchr_Y1", "wchr_Y2", "wchr_Y3","pubt_Baseline", "pub_Y1", "pub_Y2", "pub_Y3")

# Select the variables for age regressed
allt_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3")

# Subset the data for the selected variables
all_data <- data_frame %>%
  select(all_of(all_variables))

# Subset the data for the selected t variables
allt_data <- data_frame %>%
  select(all_of(allt_variables))

# Compute the correlation matrix for raw vars
cor_matrix <- cor(all_data, use = "pairwise.complete.obs")
cor_matrix

# Compute the correlation matrix for age regressed vars
cor_matrix_t <- cor(allt_data, use = "pairwise.complete.obs")
cor_matrix_t

# Create a ggheatmap
ggheatmap <- ggplot(melt(cor_matrix), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Create a ggheatmap for age regressed variables
ggheatmap <- ggplot(melt(cor_matrix_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 3) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Correlation matrix with covariates
# Select the variables for age regressed and covariates
allt_cov_variables <- c("intt_Baseline", "intt_Y1", "intt_Y2", "intt_Y3","intt_Baseline", "wchrt_Baseline", "wchrt_Y1", "wchrt_Y2", "wchrt_Y3","pubt_Baseline", "pubt_Y1", "pubt_Y2", "pubt_Y3", "int_p_ave", "famc_ave", "bw_lbs", "matage", "matalc_ave", "matcig_ave", "matmar_ave", "ses_lt")

# Subset the data for the selected t variables
allt_cov_data <- data_frame %>%
  select(all_of(allt_cov_variables))

# Compute the correlation matrix for age regressed vars + covariates
cor_matrix_cov_t <- cor(allt_cov_data, use = "pairwise.complete.obs")
cor_matrix_cov_t

# Create a ggheatmap for age regressed variables + covariates
ggheatmap <- ggplot(melt(cor_matrix_cov_t), aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "black", high = "#8e6f3e", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Pearson\nCorrelation") +
  theme_minimal() +  # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                    size = 12, hjust = 1)) +
  coord_fixed()

# Create a ggheatmap with labels on the lower triangle
ggheatmap +
  geom_text(aes(Var1, Var2, label = ifelse(as.numeric(Var1) > as.numeric(Var2), round(value, 2), "")),
            color = "black", size = 2) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(1.3, 0.1),
    legend.direction = "vertical"
  ) +
  guides(fill = guide_colorbar(barwidth = 1.3, barheight = 6,
                               title.position = "top", title.hjust = 0.5)) +
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

## Missing Data Analysis

```{r}

library(naniar)
paired_long$IID <- paired_long$IID.x
paired_long_subset_missing <- paired_long[, c("intt_b_famave", "intt_1_famave",
  "intt_2_famave", "intt_3_famave", "intt_b_sib", "intt_1_sib", "intt_2_sib", "intt_3_sib",
  "wchrt_b_famave", "wchrt_1_famave", "wchrt_2_famave", "wchrt_3_famave",
  "wchrt_b_sib", "wchrt_1_sib", "wchrt_2_sib", "wchrt_3_sib",
  "pubt_b_famave", "pubt_1_famave", "pubt_2_famave", "pubt_3_famave",
  "pubt_b_sib", "pubt_1_sib", "pubt_2_sib", "pubt_3_sib")]

vis_miss(paired_long_subset_missing)
gg_miss_var(paired_long_subset_missing)
mcar_test(paired_long_subset_missing)

```

## Export to Mplus

```{r export}
# Subset data set for mplus
all_merged_out <- all_merged[, c("sex","race3", "age_Baseline", 
                           "int_Baseline", "intt_Baseline",
                           "age_Y1", "int_Y1", "intt_Y1",
                           "age_Y2", "int_Y2", "intt_Y2",
                           "age_Y3", "int_Y3", "intt_Y3",
                           "wchr_Baseline", "wchrt_Baseline",
                           "wchr_Y1", "wchrt_Y1",
                           "wchr_Y2", "wchrt_Y2",
                           "wchr_Y3", "wchrt_Y3",
                           "pub_Baseline", "pubt_Baseline",
                           "pub_Y1", "pubt_Y1",
                           "pub_Y2", "pubt_Y2",
                           "pub_Y3", "pubt_Y3",
                           "int_p_ave", "famc_ave", "bw_lbs",
                           "matage", "matalc_ave", "matcig_ave",
                           "matmar_ave", "ses_lt")]

#install.packages("MplusAutomation")
library(MplusAutomation)

# Specify the output Mplus data file name (e.g., "data_input.dat")
mplus_data_file <- "data_input.dat"

# Export data to Mplus input format
MplusAutomation::prepareMplusData(all_merged_out,filename = "Fullsample_race3_sex_subset.dat")
```

Hallquist, M. N. & Wiley, J. F. (2018). MplusAutomation: An R Package for Facilitating Large-Scale Latent Variable Analyses in Mplus. Structural Equation Modeling, 25, 621-638. doi: 10.1080/10705511.2017.1402334.

## Model Building

### Internalizing

#### Internalizing Unconstrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/internalizing unconstrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Internalizing Constrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/internalizing constrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Loglikelihood test for Internalizing
https://www.statmodel.com/chidiff.shtml

```{r}
#install.packages("stats")
library(stats)

# Number of Free Parameters                       12
# Loglikelihood
#          H0 Value                      -71300.350
#          H0 Scaling Correction Factor      2.8090
#            for MLR
#          H1 Value                      -71257.871
#          H1 Scaling Correction Factor      2.7385
#            for MLR

# Unconstrained
L1 <- -71300.350  # Loglikelihood for the H1 model
c1 <- 2.8090  # Scaling correction factor for the H1 model
p1 <- 12     # Number of parameters for the H1 model

# Number of Free Parameters                       10
# Loglikelihood
#          H0 Value                      -71389.816
#          H0 Scaling Correction Factor      2.8983
#            for MLR
#          H1 Value                      -71257.871
#          H1 Scaling Correction Factor      2.7385
#            for MLR

# Constrained
L0 <- -71389.816  # Loglikelihood for the H0 model
c0 <- 2.8983  # Scaling correction factor for the H0 model
p0 <- 10    # Number of parameters for the H0 model

# Compute the difference test scaling correction (cd)
cd <- (p0 * c0 - p1 * c1) / (p0 - p1)

# Compute the chi-square difference test (TRd)
TRd <- -2 * (L0 - L1) / cd

# Define degrees of freedom
df <- p1 - p0

# Calculate p-value
p_value <- pchisq(TRd, df = df, lower.tail = FALSE)

# Print results
cat("Difference Test Scaling Correction (cd):", cd, "\n")
cat("Chi-Square Difference Test (TRd):", TRd, "\n")
cat("p-value:", p_value, "\n")

# Print "Cannot constrain" if p-value is less than 0.05
if (p_value < 0.05) {
  cat("Cannot constrain\n")
} else {
  cat("Constraining is acceptable\n")
}

```
### Waist Circumference to Height Ratio

#### Waist Circumference to Height Ratio Unconstrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/wchr unconstrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Waist Circumference to Height Ratio Constrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/wchr constrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Loglikelihood test for Waist Circumference to Height Ratio
https://www.statmodel.com/chidiff.shtml

```{r}

#install.packages("stats")
library(stats)

# Number of Free Parameters                       12
# Loglikelihood
#          H0 Value                       42900.924
#          H0 Scaling Correction Factor      8.5361
#            for MLR
#          H1 Value                       42910.217
#          H1 Scaling Correction Factor      7.7273
#            for MLR

# Unconstrained
L1 <- 42900.924  # Loglikelihood for the H1 model
c1 <- 8.5361  # Scaling correction factor for the H1 model
p1 <- 12     # Number of parameters for the H1 model

# Number of Free Parameters                       10
# Loglikelihood
#          H0 Value                       42844.638
#          H0 Scaling Correction Factor      9.5102
#            for MLR
#          H1 Value                       42910.217
#          H1 Scaling Correction Factor      7.7273
#            for MLR

# Constrained
L0 <- 42844.638  # Loglikelihood for the H0 model
c0 <- 9.5102  # Scaling correction factor for the H0 model
p0 <- 10    # Number of parameters for the H0 model

# Compute the difference test scaling correction (cd)
cd <- (p0 * c0 - p1 * c1) / (p0 - p1)

# Compute the chi-square difference test (TRd)
TRd <- -2 * (L0 - L1) / cd

# Define degrees of freedom
df <- p1 - p0

# Calculate p-value
p_value <- pchisq(TRd, df = df, lower.tail = FALSE)

# Print results
cat("Difference Test Scaling Correction (cd):", cd, "\n")
cat("Chi-Square Difference Test (TRd):", TRd, "\n")
cat("p-value:", p_value, "\n")

# Print "Cannot constrain" if p-value is less than 0.05
if (p_value < 0.05) {
  cat("Cannot constrain\n")
} else {
  cat("Constraining is acceptable\n")
}
```

### Puberty

#### Puberty Unconstrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/puberty unconstrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Puberty Constrained model

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/puberty constrained.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

#### Loglikelihood test for Puberty
https://www.statmodel.com/chidiff.shtml

```{r}

#install.packages("stats")
library(stats)

# Number of Free Parameters                       12
# Loglikelihood
#          H0 Value                      -32956.741
#          H0 Scaling Correction Factor      1.0634
#            for MLR
#          H1 Value                      -32935.686
#          H1 Scaling Correction Factor      1.0532
#            for MLR

# Unconstrained
L1 <- -32956.741  # Loglikelihood for the H1 model
c1 <- 1.0634  # Scaling correction factor for the H1 model
p1 <- 12     # Number of parameters for the H1 model

# Number of Free Parameters                       10
# Loglikelihood
#          H0 Value                      -32982.169
#          H0 Scaling Correction Factor      1.0510
#            for MLR
#          H1 Value                      -32935.686
#          H1 Scaling Correction Factor      1.0532
#            for MLR

# Constrained
L0 <- -32982.169  # Loglikelihood for the H0 model
c0 <-  1.0510  # Scaling correction factor for the H0 model
p0 <- 10    # Number of parameters for the H0 model

# Compute the difference test scaling correction (cd)
cd <- (p0 * c0 - p1 * c1) / (p0 - p1)

# Compute the chi-square difference test (TRd)
TRd <- -2 * (L0 - L1) / cd

# Define degrees of freedom
df <- p1 - p0

# Calculate p-value
p_value <- pchisq(TRd, df = df, lower.tail = FALSE)

# Print results
cat("Difference Test Scaling Correction (cd):", cd, "\n")
cat("Chi-Square Difference Test (TRd):", TRd, "\n")
cat("p-value:", p_value, "\n")

# Print "Cannot constrain" if p-value is less than 0.05
if (p_value < 0.05) {
  cat("Cannot constrain\n")
} else {
  cat("Constraining is acceptable\n")
}
```

Summary: Based on the above model building steps of estimating models with unconstrained and constrained cross lagged paths and then performing a likelihood ratio to test if constraining results3
1in decrements in model fit, all cross lagged paths should be left unconstrained.

## Full Sample Model  (No Covariates)

Full random intercept cross lag panel model specified according to Hamaker et al.,2015 (DOI: 10.1037/a0038889) 

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/all full model.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

```{r}
library(ggplot2)

model_results <- data.frame(
  variable = c(
               "INT_12->PUBT_13", "WHR_12->PUBT_13", "PUBT_12->PUBT_13",
               "INT_11->PUBT_12", "WHR_11->PUBT_12", "PUBT_11->PUBT_12",
               "INT_10->PUBT_11", "WHR_10->PUBT_11", "PUBT_10->PUBT_11", 
               
               "PUBT_12->INT_13", "WHR_12->INT_13", "INT_12->INT_13",
               "PUBT_11->INT_12", "WHR_11->INT_12", "INT_11->INT_12",
               "PUBT_10->INT_11", "WHR_10->INT_11", "INT_10->INT_11", 
               
               "PUBT_12->WHR_13", "INT_12->WHR_13", "WHR_12->WHR_13", 
               "PUBT_11->WHR_12", "INT_11->WHR_12", "WHR_11->WHR_12", 
               "PUBT_10->WHR_11", "INT_10->WHR_11", "WHR_10->WHR_11"), 
  
  coef = c(.386, .009, -.028,
           .368, -.001, -.048, 
           .252, -.001, -.018, 
    
           .092, .00, -.048, 
           .18, -.01, .05, 
           .05, .03, .01, 
    
           .43, -.04, .001, 
           .18, .02, .045, 
           -.09, .01,-.06),
  
  se = c(.02, .01, .01,
         .02, .01, .02,
         .02, .04, .03,
         
         .02, .02, .01, 
         .03, .04, .02, 
         .04, .04, .02, 
         
         .06, .03, .03, 
         .03, .03, .024, 
         .05, .02, .03)           
  )

# Convert variable to factor to maintain the order
model_results$variable <- factor(model_results$variable, levels = model_results$variable)

# Calculate confidence intervals (e.g., 95% CI)
model_results$lower <- model_results$coef - 1.96 * model_results$se
model_results$upper <- model_results$coef + 1.96 * model_results$se

# Create coefficient plot using ggplot2 with a vertical zero line
ggplot(model_results, aes(x = coef, y = variable, xmin = lower, xmax = upper)) +
  geom_pointrange() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +  # Add a dashed vertical line at x = 0
  labs(x = "Coefficients", y = "Paths") +
  ggtitle("Cross Lagged Associations (Full Sample)") +
  theme_minimal()

```

## Boys' Model  (No Covariates)

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/all full model boys.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

## Girls' Model  (No Covariates)

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/all full model girls.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```

## Black Youth Model  (No Covariates)

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/black full model.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```


## White Youth Model  (No Covariates)

```{r}
# Specify the path to your Mplus output file
output_path <- "C:/Users/ocrobert/OneDrive - Indiana University/ABCD/Obesity Week/Mplus/white full model.out"

# Read and print the file
output_content <- readLines(output_path)
cat(output_content, sep = "\n")
```